<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="keywords" content="跳过节假日的排期工具">
  <meta name="description" content="跳过节假日的排期工具, Momo's Blog, LuckyMomo">
  <title>跳过节假日的排期工具</title>
  <style>
  /*全局设置*/
  body::-webkit-scrollbar { display: none}
  p {
    margin: 0;
  }
  [v-cloak] {
    display: none;
  }
  #app {
    text-align: center;
    padding: 10px 50px 0;
  }
  .p-action {
    margin: 20px auto;
    max-width: 1100px;
    width: 100%;
    font-size: 35px;
    text-align: center;
    font-weight: bold;
    white-space: pre-line;
  }
  .bottom-tool {
    position: fixed;
    right: 50px;
    bottom: 20px;
    z-index: 999;
  }
  .bottom-tool-item {
    display: inline-block;
    background-color: #eff3f6;
    background-image: linear-gradient(-180deg, #fafbfc, #eff3f6 90%);
    color: #24292e;
    border: 1px solid rgba(27, 31, 35, .2);
    border-radius: 3px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    line-height: 20px;
    padding: 6px 12px;
  }
  .bottom-tool-item:hover {
    opacity: 0.9;
  }
  .intro {
    padding-left: 20px;
    text-align: left;
  }
  .intro p {
    font-size: 12px;
    color: #666666;
  }
  .action {
    position: absolute;
    top: 100px;
    right: 56px;
    text-align: right;
  }
  .action p {
    position: absolute;
    bottom: -30px;
    right: 0;
    font-size: 16px;
    text-align: right;
  }
  .action i {
    display: inline-block;
    padding: 8px 16px;
    font-size: 20px;
    color: white;
    cursor: pointer;
    border-radius: 4px;
    border: 1px solid #aaaaaa;
    background-color: #3D8AC7;
    opacity: 0.7;
    transition: 0.3s all;
  }
  .action i:hover, .active {
    opacity: 1;
  }
  .p-container {
    position: relative;
    padding-top: 6px;
  }
  .scheduling-item {
    width: 100%;
    height: 700px;
    margin-bottom: 40px;
    text-align: left;
    outline: none;
  }
  i {
    display: inline-block;
    padding: 4px 8px;
    font-size: 14px;
    color: white;
    cursor: pointer;
    border-radius: 4px;
    border: 1px solid #aaaaaa;
    background-color: #3D8AC7;
    opacity: 0.7;
    transition: 0.3s all;
  }
  i:hover, .active {
    opacity: 1;
  }
  </style>
</head>
<body>
<section id="app" v-cloak="">

  <!--顶部操作提示-->
  <section class="p-action g-box">跳过节假日的排期工具，左计划，右结果</section>
  <div class="bottom-tool">
    <a class="bottom-tool-item" target="_blank" href="https://github.com/Momo707577045/auto-scheduling">github</a>
    <a class="bottom-tool-item" target="_blank" href="./2021.html">2021 年历</a>
    <a class="bottom-tool-item" target="_blank" href="./2022.html">2022 年历</a>
    <a class="bottom-tool-item" target="_blank" href="http://blog.luckly-mjw.cn/tool-show/index.html">其他实用工具</a>
  </div>

  <!--使用说明-->
  <div class="intro">
    <p>分享链接：{{ saveLink }}</p>
    <p>* 自动剔除法定节假日的排期工具，解决人为排日期的问题</p>
    <p>* 【选填】#自定义假期：2021.12.23, 2021-12-24， 2021/12/28（设置除法定节假日外的假期时间，将自动剔除该天的排期，以逗号或空格区分）</p>
    <p>* 【选填】#自定义上班时间：2021.12.23（将自动增加该天为上班时间，以逗号或空格区分）</p>
    <p>* 【必填】#起始时间：2021.12.23（必填，用于计算排期时间）</p>
    <p>* 【选填】#结束时间：2022.1.25（用于动态提醒，剩余可用时间）</p>
    <p>* 【必填】#用时：7 天（设置项目用时，如开发#用时：7 天）</p>
  </div>

  <!--右侧操作-->
  <div class="action">
    <p>更新时间：{{ updateTime ? updateTime : '尚未线上保存'}}</p>
    <i @click="saveData(true)">生成副本</i>
    <i @click="saveData(false)">生成分享链接/保存</i>
  </div>

  <!--文件载入-->
  <section class="p-container">
    <scheduling-item
      v-for="(item, index) in schedulingList"
      class="scheduling-item"
      ref="$schedulingList"
      :key="item.key"
      :origin-value="item.originValue"
      @add-item="addItem(index)"
      @delete-item="deleteItem(index)"
    />
  </section>
</section>
</body>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?1f12b0865d866ae1b93514870d93ce89";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>
<!--vue 前端框架-->
<script src="https://cdn1.lncld.net/static/js/av-min-1.2.1.js"></script>
<script src="./vue.js"></script>
<script src="./scheduling-item.js"></script>

<script>
let urlObj = new URL(location.href)
let id = urlObj.searchParams.get('id')

new Vue({
  el: '#app',
  components: {
    'scheduling-item': window.schedulingItem,
  },

  data() {
    return {
      id: id,
      updateTime: '', // 更新时间
      saveLink: '', // 分享用的链接
      schedulingList: [], // 排期列表数
    }
  },

  mounted() {
    this.initLocalData()
    this.initAV()
  },

  methods: {

    // 格式化时间
    formatTime(date, formatStr, withoutZero) {
      const formatType = {
        Y: date.getFullYear(),
        M: date.getMonth() + 1,
        D: date.getDate(),
        h: date.getHours(),
        m: date.getMinutes(),
        s: date.getSeconds(),
      }
      return formatStr.replace(
        /Y+|M+|D+|h+|m+|s+/g,
        target => ((withoutZero ? '' : new Array(target.length).join('0')) + formatType[target[0]]).substr(-target.length)
      )
    },

    initLocalData() {
      // 根据本地缓存，恢复数据
      if (localStorage.getItem('auto-scheduling')) {
        let sourceStrList = JSON.parse(localStorage.getItem('auto-scheduling'))
        sourceStrList.forEach(item => this.schedulingList.push({ originValue: item, key: new Date().getTime() - Math.floor(Math.random() * 100000) }))
      } else {
        this.schedulingList.push({ originValue: '', key: new Date().getTime() })
      }

      // 每秒同步一次数据
      setInterval(() => {
        if (this.$refs.$schedulingList) {
          let sourceStrList = []
          this.$refs.$schedulingList.forEach(item => sourceStrList.push(item.sourceStr))
          localStorage.setItem('auto-scheduling', JSON.stringify(sourceStrList))
        }
      }, 400)
    },

    // 初始化 leanCloud 存储
    initAV() {
      AV.init({
        appId: 'GQPeMgVcofGJdnNDQw7Vj6da-gzGzoHsz',
        appKey: 'JjJi4eNhRgU5QqIjyGPICd9P',
      })
      AV.User.logIn('scheduling', 'scheduling').then(() => {
        console.log('login success')
        if (this.id) {
          this.schedulingList = []
          this.saveLink = `${location.href.split('?')[0]}?id=${this.id}`
          let query = new AV.Query('scheduling');
          query.get(this.id).then((detailData) => {
            this.updateTime = this.formatTime(new Date(detailData.updatedAt), 'YYYY/MM/DD hh:mm:ss')
            JSON.parse(detailData.attributes.sourceStrList).forEach(item =>
              this.schedulingList.push({ originValue: item, key: new Date().getTime() - Math.floor(Math.random() * 100000) }))
          }).catch(function(error) {
            alert(JSON.stringify(error));
          });
        }
      })
    },

    // 添加项目
    addItem(preIndex) {
      let item = { originValue: '', ref: null, key: new Date().getTime() }
      this.schedulingList.splice(preIndex + 1, 0, item)
    },

    // 删除特定项目
    deleteItem(index) {
      if (confirm("确定要删除吗？")) {
        this.schedulingList.length > 1 && this.schedulingList.splice(index, 1)
      }
    },

    // 将数据保存到远端
    saveData(createCopy) {
      let sourceStrList = []
      this.$refs.$schedulingList.forEach(item => sourceStrList.push(item.sourceStr))
      const schedulingClass = AV.Object.extend('scheduling')
      let scheduling = new schedulingClass()
      this.id && !createCopy && scheduling.set('id', this.id) // 如果数据存在，却不是创建副本，则更新
      scheduling.set('sourceStrList', JSON.stringify(sourceStrList))
      scheduling.save().then((res) => {
        if (createCopy) {
          window.open(`${location.href.split('?')[0]}?id=${res.id}`)
        } else {
          this.saveLink = `${location.href.split('?')[0]}?id=${res.id}`
          this.updateTime = this.formatTime(new Date(res.updatedAt), 'YYYY/MM/DD hh:mm:ss')

          let $input = document.createElement('textarea')
          $input.style.opacity = '0'
          $input.value = this.saveLink
          document.body.appendChild($input)
          $input.select()

          document.execCommand('copy')
          document.body.removeChild($input)
          $input = null
          window.history.replaceState(null, '', this.saveLink)
        }
        alert(`保存成功，信息ID为：${res.id}，分享链接已复制`)
      }, function(error) {
        alert(JSON.stringify(error));
      });
    }
  },
})
</script>
</html>
